name: DevSecOps AI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger from GitHub UI
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan on Sunday

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '14'
  PYTHON_VERSION: '3.9'

jobs:
  # SAST - Static Application Security Testing
  sast-scan:
    name: SAST Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit (Python SAST)
        continue-on-error: true
        run: |
          mkdir -p data/reports
          bandit -r . -f json -o data/reports/bandit_report.json || true
          bandit -r . -f html -o data/reports/bandit_report.html || true
          echo "Generated reports:"
          ls -lh data/reports/ || echo "No reports directory"

      - name: Run SpotBugs (Java SAST)
        continue-on-error: true
        working-directory: sample_app_java/backend
        run: |
          mvn compile spotbugs:spotbugs || true

      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: data/reports/

  # SCA - Software Composition Analysis
  sca-scan:
    name: SCA Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety
          mkdir -p data/reports

      - name: Run Safety Check (Python)
        continue-on-error: true
        run: |
          safety check --json --output data/reports/safety_report.json || true
          echo "Safety report generated:"
          ls -lh data/reports/safety_report.json 2>/dev/null || echo "No safety report"

      - name: Run OWASP Dependency-Check (Java)
        uses: dependency-check/Dependency-Check_Action@main
        continue-on-error: true
        with:
          project: 'vulnerable-app'
          path: 'sample_app_java/backend'
          format: 'ALL'
          out: 'data/reports'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit (JavaScript)
        continue-on-error: true
        working-directory: sample_app_java/frontend
        run: |
          npm audit --json > ../../data/reports/npm_audit.json || true

      - name: Upload SCA Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sca-reports
          path: data/reports/

  # Build and Test
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [sast-scan, sca-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Build Spring Boot Backend
        working-directory: sample_app_java/backend
        run: mvn clean package -DskipTests

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build React Frontend
        working-directory: sample_app_java/frontend
        env:
          CI: false
        run: |
          npm install
          npm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            sample_app_java/backend/target/*.jar
            sample_app_java/frontend/build/

  # DAST - Dynamic Application Security Testing
  dast-scan:
    name: DAST Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Start Application
        run: |
          java -jar sample_app_java/backend/target/*.jar &
          sleep 30

      - name: Run OWASP ZAP Scan
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        with:
          docker: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'

      - name: Upload DAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-reports
          path: |
            zap_report.html
            zap_report.json

  # AI-Powered Policy Generation
  generate-policies:
    name: Generate Security Policies
    runs-on: ubuntu-latest
    needs: [sast-scan, sca-scan, dast-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install DevSecOps AI
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          pattern: '*-reports'
          merge-multiple: true
          
      - name: Organize Reports
        run: |
          echo "ðŸ“ Organizing downloaded reports..."
          mkdir -p data/reports
          # Move all JSON/HTML files to data/reports/
          find . -name "*.json" -o -name "*.html" | while read file; do
            if [[ "$file" != "./data/reports/"* ]]; then
              echo "Moving: $file"
              cp "$file" data/reports/ 2>/dev/null || true
            fi
          done

      - name: List Downloaded Reports
        run: |
          echo "ðŸ“ Checking for downloaded reports:"
          echo "Current directory: $(pwd)"
          echo "Directory structure:"
          ls -laR data/ || echo "âŒ No data directory"
          echo ""
          echo "Looking for JSON reports:"
          find . -name "*.json" -type f | head -20
          echo ""
          REPORT_COUNT=$(find data/reports -name "*.json" -type f 2>/dev/null | wc -l)
          echo "Found $REPORT_COUNT JSON reports in data/reports/"
          if [ "$REPORT_COUNT" -eq 0 ]; then
            echo "âš ï¸  WARNING: No reports found! Policy generation may fail."
          fi

      - name: Install and Setup Ollama
        run: |
          echo "ðŸ”§ Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          
          echo "ðŸš€ Starting Ollama service..."
          ollama serve > /tmp/ollama.log 2>&1 &
          OLLAMA_PID=$!
          echo "Ollama PID: $OLLAMA_PID"
          
          echo "â³ Waiting for Ollama to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags >/dev/null 2>&1; then
              echo "âœ… Ollama is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          echo "ðŸ“¥ Pulling qwen2.5:1.5b model..."
          ollama pull qwen2.5:1.5b || {
            echo "âŒ Failed to pull model"
            cat /tmp/ollama.log
            exit 1
          }
          
          echo "âœ… Ollama setup complete"
          ollama list

      - name: Generate Security Policies with AI
        env:
          LLM_PROVIDER: ollama
          OLLAMA_HOST: ${{ secrets.OLLAMA_HOST || 'http://localhost:11434' }}
          LLM_MODEL: qwen2.5:1.5b
        run: |
          mkdir -p output/generated_policies
          python main.py generate --input data/reports --output output/generated_policies || {
            echo "âŒ Policy generation failed"
            exit 1
          }

      - name: Verify Generated Policies
        run: |
          echo "ðŸ“„ Generated policies:"
          ls -la output/generated_policies/ || echo "No policies directory found"
          POLICY_COUNT=$(find output/generated_policies -type f -name "*.json" 2>/dev/null | wc -l)
          echo "Found $POLICY_COUNT policy files"
          if [ "$POLICY_COUNT" -eq 0 ]; then
            echo "âŒ No policies were generated!"
            exit 1
          fi

      - name: Upload Generated Policies
        uses: actions/upload-artifact@v4
        with:
          name: security-policies
          path: output/generated_policies/

      - name: Evaluate Generated Policies
        run: |
          python main.py evaluate \
            --policies output/generated_policies \
            --reference data/reference_policies \
            --output output/evaluation_results

      - name: Generate Dashboard Report
        run: |
          python scripts/generate_final_report.py \
            --evaluation output/evaluation_results \
            --policies output/generated_policies \
            --output output/FINAL_REPORT

      - name: Upload Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: dashboard
          path: |
            output/FINAL_REPORT.md
            output/FINAL_REPORT

  # Security Gate - Fail if critical issues found
  security-gate:
    name: Security Quality Gate
    runs-on: ubuntu-latest
    needs: [sast-scan, sca-scan, dast-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          pattern: '*-reports'
          merge-multiple: true

      - name: Evaluate Security Posture
        run: |
          python -m pip install jq
          
          # Count critical/high vulnerabilities
          CRITICAL_COUNT=$(find . -name "*_report.json" -exec jq '[.. | select(.severity? == "CRITICAL" or .severity? == "HIGH")] | length' {} \; 2>/dev/null | awk '{s+=$1} END {print s}')
          
          echo "Critical/High vulnerabilities found: $CRITICAL_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 10 ]; then
            echo "::error::Too many critical/high vulnerabilities detected!"
            exit 1
          fi

      - name: Post Security Summary
        if: always()
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… SAST Scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… SCA Scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… DAST Scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Policy Generation: Completed" >> $GITHUB_STEP_SUMMARY
