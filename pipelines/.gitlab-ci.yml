# GitLab CI/CD Pipeline for DevSecOps AI
# This pipeline integrates SAST, SCA, and DAST security scanning

stages:
  - build
  - test
  - security_scan
  - policy_generation
  - evaluation
  - deploy

variables:
  PYTHON_VERSION: "3.9"
  SONARQUBE_URL: $SONARQUBE_URL
  ZAP_VERSION: "latest"

# Build stage
build:
  stage: build
  image: python:${PYTHON_VERSION}
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  artifacts:
    paths:
      - venv/
    expire_in: 1 day
  cache:
    paths:
      - .cache/pip

# Unit tests
test:unit:
  stage: test
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
  script:
    - source venv/bin/activate
    - pytest tests/unit --cov=. --cov-report=xml --cov-report=html
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 30 days

# SAST - Static Application Security Testing
sast:sonarqube:
  stage: security_scan
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
      -Dsonar.projectKey=${CI_PROJECT_NAME}
      -Dsonar.sources=.
      -Dsonar.host.url=${SONARQUBE_URL}
      -Dsonar.login=${SONARQUBE_TOKEN}
      -Dsonar.python.coverage.reportPaths=coverage.xml
  allow_failure: false
  only:
    - main
    - merge_requests

# SAST - Bandit Security Scanner
sast:bandit:
  stage: security_scan
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
  script:
    - source venv/bin/activate
    - pip install bandit
    - bandit -r . -f json -o data/reports/bandit_report.json || true
    - bandit -r . -f html -o data/reports/bandit_report.html || true
  artifacts:
    paths:
      - data/reports/bandit_report.*
    expire_in: 30 days
  allow_failure: true

# SCA - Software Composition Analysis
sca:dependency_check:
  stage: security_scan
  image: owasp/dependency-check:latest
  script:
    - /usr/share/dependency-check/bin/dependency-check.sh
      --scan .
      --format JSON
      --format HTML
      --out data/reports/
      --project "DevSecOps AI"
  artifacts:
    paths:
      - data/reports/dependency-check-report.*
    expire_in: 30 days
  allow_failure: true

# SCA - Safety (Python dependencies)
sca:safety:
  stage: security_scan
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
  script:
    - source venv/bin/activate
    - pip install safety
    - safety check --json --output data/reports/safety_report.json || true
  artifacts:
    paths:
      - data/reports/safety_report.json
    expire_in: 30 days
  allow_failure: true

# DAST - Dynamic Application Security Testing
dast:zap_scan:
  stage: security_scan
  image: owasp/zap2docker-stable
  script:
    # Baseline scan for quick vulnerability detection
    - zap-baseline.py 
      -t ${TARGET_URL} 
      -J data/reports/zap_baseline_report.json
      -r data/reports/zap_baseline_report.html
      -I || true
  artifacts:
    paths:
      - data/reports/zap_*
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - merge_requests
  when: manual

# Policy Generation - LLM Integration
policy_generation:
  stage: policy_generation
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
    - sast:bandit
    - sca:dependency_check
    - sca:safety
  script:
    - source venv/bin/activate
    - echo "Generating security policies from vulnerability reports..."
    - python main.py generate 
      --input data/reports/ 
      --output output/generated_policies/
      --framework NIST_CSF
    - python main.py generate 
      --input data/reports/ 
      --output output/generated_policies/
      --framework ISO_27001
  artifacts:
    paths:
      - output/generated_policies/
    expire_in: 30 days
  only:
    - main
    - merge_requests

# Evaluation - Metrics Calculation
evaluation:
  stage: evaluation
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
    - policy_generation
  script:
    - source venv/bin/activate
    - echo "Evaluating generated policies..."
    - python main.py evaluate
      --policies output/generated_policies/
      --reference data/reference_policies/
      --output output/evaluation_results/
    - cat output/evaluation_results/summary.json
  artifacts:
    paths:
      - output/evaluation_results/
    reports:
      junit: output/evaluation_results/junit_report.xml
    expire_in: 30 days
  only:
    - main
    - merge_requests

# Generate final report
generate_report:
  stage: deploy
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
    - evaluation
  script:
    - source venv/bin/activate
    - python scripts/generate_final_report.py
      --evaluation output/evaluation_results/
      --policies output/generated_policies/
      --output reports/final_report.pdf
  artifacts:
    paths:
      - reports/final_report.pdf
    expire_in: 90 days
  only:
    - main

# Deploy documentation
pages:
  stage: deploy
  image: python:${PYTHON_VERSION}
  dependencies:
    - build
  script:
    - source venv/bin/activate
    - pip install mkdocs mkdocs-material
    - mkdocs build
    - mv site public
  artifacts:
    paths:
      - public
  only:
    - main
